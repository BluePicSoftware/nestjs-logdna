{"version":3,"file":"logdna.middleware.js","sourceRoot":"/","sources":["logdna.middleware.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { defaultReqTransform, defaultResTransform, LogDNAhttpLoggerOptions } from './logdna.options';\nimport { LogDNAService } from './logdna.service';\nimport { getClientIp } from '@supercharge/request-ip';\n\nexport function LogDNAhttpLogger(options: LogDNAhttpLoggerOptions) {\n  return function(req: Request, res: Response, next: NextFunction) {\n    const begin = Date.now();\n    const { method, url } = req;\n    var end = res.end;\n    // @ts-expect-error\n    res.end = function (chunk, encoding) {\n      const duration = Date.now() - begin;\n\n      res.end = end;\n      res.end(chunk, encoding);\n\n      if (!(options?.filter?.(req, res) ?? true)) {\n        return;\n      }  \n\n      const { statusCode } = res;\n      let msg =\n        options?.messageFormat?.(req, res) ??\n        `[${method}] ${url} ${statusCode} ${duration}ms`;\n      if(res.locals?.errorRef) {\n        msg += ` Error: ${res.locals.errorRef}`;\n      }\n      let body;\n      if (chunk) {\n        const contentType = res.getHeader('content-type')?.toString();\n        if(contentType?.includes('text')) {\n          body = chunk.toString();\n        }\n        else if(contentType?.includes('json')) {\n          body = safeJSONParse(chunk.toString());\n        }\n      }\n      const defaultReqDTO = reqDTO(req);\n      const defaultResDTO = resDTO(res, body);\n      const reqMeta = options?.reqMetaTransform?.(req, defaultReqDTO) ?? defaultReqDTO;\n      const resMeta = options?.resMetaTransform?.(res, defaultResDTO) ?? defaultResDTO;\n      LogDNAService.LogDNAServiceInstance().http(msg, reqMeta, resMeta);\n    }\n    next();\n  };\n}\n\nfunction reqDTO(req: Request): defaultReqTransform {\n  return {\n    protocol: req.protocol,\n    ip: getClientIp(req),\n    path: req.url,\n    params: req.params,\n    method: req.method,\n    headers: req.headers,\n    body: req.body,\n  }\n}\n\nfunction resDTO(res: Response, body: any): defaultResTransform {\n  return {\n    statusCode: res.statusCode,\n    statusMessage: res.statusMessage,\n    headers: res.getHeaders(),\n    locals: res.locals,\n    body,\n  }\n}\n\nfunction safeJSONParse(input: string) {\n  try {\n      return JSON.parse(input);\n  } catch (e) {\n      return input;\n  }\n}"]}